# ğŸ” SPI Debugger

SPI Debugger å…è®¸ç”¨æˆ·é€šè¿‡ SPI æ¥å£è®¿é—®ç‰‡ä¸Šæ€»çº¿ï¼Œä»è€Œè°ƒè¯• SoC çš„å„ç§å¤–è®¾ã€‚

å®ƒçš„è¾“å…¥ä¾§ç«¯å£æ˜¯ä¸€ç»„ SPI çš„ Slave æ¥å£ï¼Œè¾“å…¥ä¾§ç«¯å£æ˜¯ä¸€ç»„ Acorn Dp Bus çš„ Master æ¥å£ï¼Œåè€…å¯ä»¥å®¹æ˜“åœ°è½¬æ¢æˆ AXI ç­‰æ¥å£è¿æ¥åˆ°SoC æ€»çº¿ä¸Šã€‚

## Register Map

SPI Debugger å†…éƒ¨å¯„å­˜å™¨å®šä¹‰å¦‚ä¸‹ï¼š

### BUS_ADDR_H (0x00)

è¯¥å¯„å­˜å™¨ä»…å½“é…ç½®é€‰é¡¹ `busAddrWidth` > 32 æ—¶æ‰ä¼šå­˜åœ¨ï¼Œä¸”åªæœ‰å…¶ä½ (`busAddrWidth`-32) bit å¯è¢«è®¿é—®ã€‚

å…¶å€¼ä¸å¯„å­˜å™¨ `BUS_ADDR_L` ç»„åˆåœ¨ä¸€èµ·ä½œä¸ºæ€»çº¿è®¿é—®åœ°å€ï¼ˆ`wr/rd.cmd.bits.addr`ï¼‰ã€‚

![spi-debugger-reg-addrh](./assets/spi-debugger-reg-addrh.jpg)

å›¾ä¸­çš„ä¾‹å­æ˜¯ `busAddrWidth` = 45 æ—¶çš„æƒ…å†µã€‚

### `BUS_ADDR_L` (0x01)

å½“é…ç½®é€‰é¡¹ `busAddrWidth` > 32 æ—¶ï¼Œå¯„å­˜å™¨ `BUS_ADDR_L` ä¸è¯¥å¯„å­˜å™¨çš„å€¼ç»„åˆåœ¨ä¸€èµ·ä½œä¸ºæ€»çº¿è®¿é—®åœ°å€ï¼›å¦åˆ™ï¼Œè¯¥å¯„å­˜å™¨çš„ä½ `busAddrWidth` bit ä½œä¸ºæ€»çº¿è®¿é—®åœ°å€ï¼ˆ`wr/rd.cmd.bits.addr`ï¼‰ã€‚

![spi-debugger-reg-addrl](./assets/spi-debugger-reg-addrl.jpg)

### `BUS_WR_RESP` (`0x02`)

è¯»å–è¯¥å¯„å­˜å™¨ï¼Œå…¶æœ€ä½ bit è¡¨ç¤ºä¸Šä¸€æ¬¡æ€»çº¿å†™æ“ä½œæ˜¯å¦æˆåŠŸï¼ˆ`wr.resp.bits.status`ï¼‰ï¼Œ0 è¡¨ç¤ºæˆåŠŸï¼Œ1 è¡¨ç¤ºæœ‰é”™è¯¯å‘ç”Ÿã€‚

å†™å…¥è¯¥å¯„å­˜å™¨ï¼ˆæ— è®ºå†™ 1 æˆ–è€… 0ï¼‰ï¼Œä¼šå‘èµ·ä¸€æ¬¡æ€»çº¿å†™æ“ä½œã€‚

![spi-debugger-reg-wresp](./assets/spi-debugger-reg-resp.jpg)

### `BUS_RD_RESP` (`0x03`)

è¯»å–è¯¥å¯„å­˜å™¨ï¼Œå…¶æœ€ä½ bit è¡¨ç¤ºä¸Šä¸€æ¬¡æ€»çº¿è¯»æ“ä½œæ˜¯å¦æˆåŠŸï¼ˆ`rd.resp.bits.status`ï¼‰ï¼Œ0 è¡¨ç¤ºæˆåŠŸï¼Œ1 è¡¨ç¤ºæœ‰é”™è¯¯å‘ç”Ÿã€‚

å†™å…¥è¯¥å¯„å­˜å™¨ï¼ˆæ— è®ºå†™ 1 æˆ–è€… 0ï¼‰ï¼Œä¼šå‘èµ·ä¸€æ¬¡æ€»çº¿è¯»æ“ä½œã€‚

![spi-debugger-reg-rresp](./assets/spi-debugger-reg-resp.jpg)

### `BUS_WR_DATA` (`0x04`)

è¯¥å¯„å­˜å™¨çš„å€¼ä½œä¸ºæ€»çº¿å†™æ“ä½œçš„æ•°æ®ï¼ˆ`wr.cmd.bits.wdata`ï¼‰ã€‚

![spi-debugger-reg-rresp](./assets/spi-debugger-reg-data.jpg)

### `BUS_RD_DATA` (`0x05`)

è¯»å–è¯¥å¯„å­˜å™¨ï¼Œå°†è¿”å›ä¸Šä¸€æ¬¡æ€»çº¿è¯»æ“ä½œçš„è¿”å›æ•°æ®ï¼ˆ`rd.resp.bits.rdata`ï¼‰ã€‚

![spi-debugger-reg-rresp](./assets/spi-debugger-reg-data.jpg)

### `BUS_WR_MASK` (`0x06`)

è¯¥å¯„å­˜å™¨çš„å€¼ä½œä¸ºæ€»çº¿å†™æ“ä½œçš„æ•°æ®æ©ç ï¼ˆ`wr.cmd.bits.wmask`ï¼‰ã€‚

![spi-debugger-reg-rresp](./assets/spi-debugger-reg-wmask.jpg)

### `TEST` (`0x3F`)

è¯¥å¯„å­˜å™¨ç”¨äº SPI çš„ Loopback è¯»å†™æµ‹è¯•ï¼Œå…¶å€¼å¯¹æ€»çº¿ä¸ä¼šæœ‰ä»»ä½•å½±å“ã€‚

![spi-debugger-reg-test](./assets/spi-debugger-reg-test.jpg)

## SPI Command Sequences

è¦é€šè¿‡ SPI Debugger è®¿é—®å…¶å†…éƒ¨å¯„å­˜å™¨å’Œæ€»çº¿ä¾§ Acorn Bus æ¥å£ï¼ŒMaster ä¾§çš„ SPI Controller åº”å½“ï¼š
1. æ‹‰ä½ SSN å¯åŠ¨ SPI ä¼ è¾“ï¼›
2. å‘é€ 1 byte çš„ Commandï¼›
3. æ ¹æ®ä¸åŒçš„ Commandï¼Œå‘é€æˆ–æ¥æ”¶è‹¥å¹²å­—èŠ‚çš„æ•°æ®ï¼›
4. æ‹‰é«˜ SSN ç»“æŸ SPI ä¼ è¾“ã€‚

SPI Debugger æ”¯æŒçš„ Command åŒ…æ‹¬ï¼š
- `REG_WR` (`0x00xx_xxxx`)ï¼šå†™å†…éƒ¨å¯„å­˜å™¨ï¼Œä½ 6 bit ç”¨äºåŒºåˆ†å¯„å­˜å™¨ï¼›
- `REG_RD` (`0x01xx_xxxx`)ï¼šè¯»å†…éƒ¨å¯„å­˜å™¨ï¼Œä½ 6 bit ç”¨äºåŒºåˆ†å¯„å­˜å™¨ï¼›
- `BUS_WR` (`0b1000_0000`)ï¼šå†™æ€»çº¿ï¼›
- `BUS_RD` (`0b1100_0000`)ï¼šè¯»æ€»çº¿ï¼›
- `NOP` (`0b1xxx_xxxx`)ï¼šç©ºæ“ä½œã€‚

### `REG_WR`

å…¶ä¼ è¾“åºåˆ—ä¸ºï¼š`Command` (8b) + `WrData` (32b)

åœ¨ `WrData` é˜¶æ®µï¼ŒMaster éœ€è¦å°† 32 bit çš„å¾…å†™æ•°æ®é€šè¿‡ MOSI çº¿å‘é€ç»™ SPI Debuggerã€‚SPI Debugger åœ¨æ¥æ”¶åˆ° 32 bit æ•°æ®åï¼Œå°†å…¶å†™å…¥å¯¹åº”çš„å¯„å­˜å™¨ã€‚

### `REG_RD`

å…¶ä¼ è¾“åºåˆ—ä¸ºï¼š`Command` (8b) + `RdData` (32b)

åœ¨ `WrData` é˜¶æ®µï¼ŒSPI Debugger å°† 32 bit çš„å¯„å­˜å™¨è¯»å‡ºæ•°æ®é€šè¿‡ MISO çº¿å‘é€ç»™ SPI Masterã€‚

### `BUS_WR`

å…¶ä¼ è¾“åºåˆ—ä¸ºï¼š`Command` (8b) + `Addr` (32b) + `WrData` (32b)

åœ¨ `Addr` å’Œ `WrData` é˜¶æ®µï¼ŒMaster éœ€è¦åˆ†åˆ«å°† 32 bit çš„å¾…å†™åœ°å€å’Œå¾…å†™æ•°æ®å‘é€ç»™ SPI Debuggerã€‚SPI Debugger ä¼šå°†å®ƒä»¬å¡«å…¥å¯„å­˜å™¨ `BUS_ADDR_L` å’Œ `BUS_WR_DATA`ï¼Œç„¶åç«‹åˆ»å‘èµ·ä¸€æ¬¡æ€»çº¿å†™æ“ä½œã€‚

### `BUS_RD`

å…¶ä¼ è¾“åºåˆ—ä¸ºï¼š`Command` (8b) + `Addr` (32b) + `Dummy` (8b) + `RdData` (32b)

åœ¨ `Addr` é˜¶æ®µï¼ŒMaster éœ€è¦å°† 32 bit çš„å¾…è¯»åœ°å€å‘é€ç»™ SPI Debuggerã€‚SPI Debugger ä¼šå°†å…¶å¡«å…¥å¯„å­˜å™¨ `BUS_ADDR_L`ï¼Œç„¶åç«‹åˆ»å‘èµ·ä¸€æ¬¡æ€»çº¿è¯»æ“ä½œã€‚åœ¨ `RdData` é˜¶æ®µï¼ŒSPI Debugger å°†æ€»çº¿è¿”å›çš„è¯»å‡ºæ•°æ®é€šè¿‡ MISO çº¿å‘é€ç»™ SPI Masterã€‚

### `NOP`

å…¶ä¼ è¾“åºåˆ—ä¸ºï¼š`Command` (8b)

ç©ºæ“ä½œï¼Œä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿã€‚

## Common Issues

1. å³ä½¿éœ€è¦è¿ç»­å¤šæ¬¡è®¿é—®ï¼ŒæœŸé—´ä¹Ÿå¿…é¡»å…ˆæ‹‰é«˜ SSN ç»“æŸå½“å‰ SPI ä¼ è¾“ï¼Œå†æ‹‰ä½ SSN å¼€å§‹ä¸‹ä¸€æ¬¡ä¼ è¾“ï¼›
2. åœ¨æ‹‰é«˜ SSN ç»“æŸå½“å‰ SPI ä¼ è¾“å‰ï¼Œè¯·åŠ¡å¿…ç¡®å®šå·²ç»å®Œæˆäº†æ•´ä¸ªæ“ä½œåºåˆ—æ‰€éœ€çš„æ•°æ®ä¼ è¾“ï¼ˆå³ç­‰å¾…è¶³å¤Ÿçš„æ—¶é—´ï¼‰ï¼›
3. SPI çš„ä¼ è¾“é€Ÿç‡ä¸å®œè¿‡é«˜ï¼ŒåŸåˆ™ä¸Š SCK çš„é¢‘ç‡åº”å½“æ¯”ç³»ç»Ÿæ—¶é’Ÿè‡³å°‘ä½å››å€ã€‚
